name: release-$(Date:yyyyMMdd)$(Rev:.r)

# Manual-only. No automatic runs on push/PR.
trigger: none
pr: none

parameters:
  - name: targetFlavors
    displayName: Target flavors (comma separated) or 'all'
    type: string
    default: all
  - name: updatePlayListing
    displayName: Update Play listing/metadata/screenshots/release-notes from repo (requires app/src/<flavor>/play)
    type: boolean
    default: false

variables:
  - group: android-release-secrets

  - name: GRADLE_OPTS
    value: -Dorg.gradle.jvmargs=-Xmx6g -Dorg.gradle.daemon=false
  - name: GRADLE_USER_HOME
    value: $(Agent.ToolsDirectory)/.gradle
  - name: ANDROID_SDK_ROOT
    value: $(Agent.ToolsDirectory)/android-sdk
  - name: ANDROID_HOME
    value: $(Agent.ToolsDirectory)/android-sdk
  - name: ANDROID_API_LEVEL
    value: 36

  # Default false; override when queuing the run:
  #   az pipelines run --name release --variables PUBLISH_TO_PLAY=true ...
  - name: PUBLISH_TO_PLAY
    value: false

stages:
  - stage: BuildRelease
    displayName: Build Signed Release
    jobs:
      - job: BuildSelected
        displayName: Build Selected Release AAB
        pool:
          name: MSI
          demands:
            - Agent.Name -equals msi
        steps:
          - checkout: self
            fetchDepth: 0

          - template: templates/steps/setup-android.yml
            parameters:
              androidApiLevel: 36

          - template: templates/steps/resolve-flavors.yml
            parameters:
              targetFlavors: ${{ parameters.targetFlavors }}

          - bash: |
              set -euo pipefail
              if [ -z "${RESOLVED_FLAVORS_JSON:-}" ] || [ -z "${RESOLVED_FLAVORS_CSV:-}" ]; then
                echo "Resolved flavor variables are missing after resolve-flavors step."
                exit 1
              fi
              echo "##vso[task.setvariable variable=RESOLVED_FLAVORS_JSON;isOutput=true]${RESOLVED_FLAVORS_JSON}"
              echo "##vso[task.setvariable variable=RESOLVED_FLAVORS_CSV;isOutput=true]${RESOLVED_FLAVORS_CSV}"
            name: resolveFlavorsOut
            displayName: Export Resolved Flavors (Stage Output)
            env:
              RESOLVED_FLAVORS_JSON: $(RESOLVED_FLAVORS_JSON)
              RESOLVED_FLAVORS_CSV: $(RESOLVED_FLAVORS_CSV)

          - bash: |
              set -euo pipefail
              if [ -n "${FIREBASE_CONFIGS_ZIP_BASE64:-}" ] && [[ "${FIREBASE_CONFIGS_ZIP_BASE64}" != '$('* ]]; then
                echo "$FIREBASE_CONFIGS_ZIP_BASE64" | base64 -d > firebase_configs.zip
                unzip -o firebase_configs.zip
                rm -f firebase_configs.zip
                echo "Firebase configs overridden from secret."
              else
                echo "No Firebase override secret, using repository defaults."
              fi
            displayName: Optional Firebase Override
            env:
              FIREBASE_CONFIGS_ZIP_BASE64: $(FIREBASE_CONFIGS_ZIP_BASE64)

          - bash: |
              set -euo pipefail
              python3 ./scripts/ci/verify_google_signin_config.py --flavors "${RESOLVED_FLAVORS_CSV}"
            displayName: Validate Google Sign-In Config

          - template: templates/steps/setup-secrets.yml
            parameters:
              needSigning: true
              needPlayServiceAccount: false

          # Release pipeline is AAB-only for faster runtime.
          - template: templates/steps/build.yml
            parameters:
              buildType: Release
              doAssemble: false
              doBundle: true

          - task: PublishPipelineArtifact@1
            displayName: Publish AAB Outputs
            inputs:
              targetPath: $(System.DefaultWorkingDirectory)/app/build/outputs/bundle
              artifact: release-bundles

          - bash: |
              set -euo pipefail
              rm -f "$(Pipeline.Workspace)/release.jks" firebase_configs.zip
            displayName: Cleanup Secrets
            condition: always()

  - stage: PublishProduction
    displayName: Publish to Play Console
    dependsOn: BuildRelease
    condition: and(succeeded(), eq(variables['PUBLISH_TO_PLAY'], 'true'))
    variables:
      RESOLVED_FLAVORS_JSON: $[ stageDependencies.BuildRelease.BuildSelected.outputs['resolveFlavorsOut.RESOLVED_FLAVORS_JSON'] ]
      RESOLVED_FLAVORS_CSV: $[ stageDependencies.BuildRelease.BuildSelected.outputs['resolveFlavorsOut.RESOLVED_FLAVORS_CSV'] ]
    jobs:
      - deployment: Publish
        displayName: Publish Bundles
        environment: production
        pool:
          name: MSI
          demands:
            - Agent.Name -equals msi
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 1

                - task: DownloadPipelineArtifact@2
                  displayName: Download AAB Outputs
                  inputs:
                    artifact: release-bundles
                    path: $(System.DefaultWorkingDirectory)/app/build/outputs/bundle

                - template: templates/steps/setup-secrets.yml
                  parameters:
                    needSigning: true
                    needPlayServiceAccount: true

                - template: templates/steps/publish-play.yml
                  parameters:
                    updatePlayListing: ${{ parameters.updatePlayListing }}
                    track: production
                    allowBundleFallback: false

                - bash: |
                    set -euo pipefail
                    rm -f "$(Pipeline.Workspace)/release.jks" "$(Pipeline.Workspace)/service-account.json"
                  displayName: Cleanup Secrets
                  condition: always()
