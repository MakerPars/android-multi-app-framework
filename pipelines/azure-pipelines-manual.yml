name: manual-ops-$(Date:yyyyMMdd)$(Rev:.r)

# Manual-only. No automatic runs on push/PR.
trigger: none
pr: none

parameters:
  - name: targetFlavor
    displayName: Target flavor
    type: string
    default: all
  - name: buildType
    displayName: Build type
    type: string
    default: Debug
    values:
      - Debug
      - Release
  - name: doQuality
    displayName: Run quality checks (detekt/ktlint/lint)
    type: boolean
    default: false
  - name: doBuild
    displayName: Build APK/AAB
    type: boolean
    default: true
  - name: doInternalTest
    displayName: Publish to Play Internal testing track (AAB, Release only)
    type: boolean
    default: false
  - name: doPublish
    displayName: Publish to Play Production track (AAB, Release only)
    type: boolean
    default: false
  - name: updatePlayListing
    displayName: Update Play listing/metadata/screenshots/release-notes from repo (requires app/src/<flavor>/play)
    type: boolean
    default: false

variables:
  - group: android-release-secrets

  # Hosted agents can have limited RAM; keep Gradle/R8 stable.
  - name: GRADLE_OPTS
    value: -Dorg.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvmargs=-Xmx1g -Dorg.gradle.workers.max=2 -Dorg.gradle.daemon=false
  - name: GRADLE_USER_HOME
    value: $(Agent.ToolsDirectory)/.gradle
  - name: ANDROID_SDK_ROOT
    value: $(Agent.ToolsDirectory)/android-sdk
  - name: ANDROID_HOME
    value: $(Agent.ToolsDirectory)/android-sdk
  - name: ANDROID_API_LEVEL
    value: 36

jobs:
  - job: ManualOps
    displayName: Manual Ops
    pool:
      name: MSI
      demands:
        - Agent.Name -equals msi
    steps:
      - checkout: self
        fetchDepth: 0

      - template: templates/steps/setup-android.yml
        parameters:
          androidApiLevel: 36

      - bash: |
          set -euo pipefail
          if [ "${{ parameters.doInternalTest }}" = "true" ] || [ "${{ parameters.doPublish }}" = "true" ]; then
            if [ "${{ parameters.buildType }}" != "Release" ]; then
              echo "buildType must be Release when doInternalTest/doPublish is enabled."
              exit 1
            fi
          fi
        displayName: Preflight Inputs

      - template: templates/steps/resolve-flavors.yml
        parameters:
          targetFlavor: ${{ parameters.targetFlavor }}

      - bash: |
          set -euo pipefail
          if [ -n "${FIREBASE_CONFIGS_ZIP_BASE64:-}" ] && [[ "${FIREBASE_CONFIGS_ZIP_BASE64}" != '$('* ]]; then
            echo "$FIREBASE_CONFIGS_ZIP_BASE64" | base64 -d > firebase_configs.zip
            unzip -o firebase_configs.zip
            rm -f firebase_configs.zip
            echo "Firebase configs overridden from secret."
          else
            echo "No Firebase override secret, using repository defaults."
          fi
        displayName: Optional Firebase Override
        env:
          FIREBASE_CONFIGS_ZIP_BASE64: $(FIREBASE_CONFIGS_ZIP_BASE64)

      - bash: |
          set -euo pipefail
          python3 ./scripts/ci/verify_google_signin_config.py --flavors "${RESOLVED_FLAVORS_CSV}"
        displayName: Validate Google Sign-In Config

      - ${{ if eq(parameters.doQuality, true) }}:
        - bash: |
            set -euo pipefail
            # detekt/ktlint are global; lint is per-flavor.
            ./gradlew detekt ktlintCheck --stacktrace --no-daemon --max-workers=2

            mapfile -t FLAVORS < <(
              echo "$RESOLVED_FLAVORS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
            )
            TASKS=()
            for flavor in "${FLAVORS[@]}"; do
              [ -z "$flavor" ] && continue
              cap="$(tr '[:lower:]' '[:upper:]' <<< "${flavor:0:1}")${flavor:1}"
              TASKS+=("lint${cap}Debug")
            done
            if [ "${#TASKS[@]}" -gt 0 ]; then
              ./gradlew "${TASKS[@]}" --stacktrace --no-daemon --max-workers=2
            fi
          displayName: Run Quality Checks

      - template: templates/steps/setup-secrets.yml
        parameters:
          needSigning: ${{ and(eq(parameters.buildType, 'Release'), or(eq(parameters.doBuild, true), eq(parameters.doInternalTest, true), eq(parameters.doPublish, true))) }}
          needPlayServiceAccount: ${{ or(eq(parameters.doInternalTest, true), eq(parameters.doPublish, true)) }}

      - ${{ if eq(parameters.doBuild, true) }}:
        - template: templates/steps/build.yml
          parameters:
            buildType: ${{ parameters.buildType }}
            # Release'te APK assemble yapma; sadece AAB bundle Ã¼ret.
            doAssemble: ${{ ne(parameters.buildType, 'Release') }}
            doBundle: ${{ eq(parameters.buildType, 'Release') }}

        - task: PublishPipelineArtifact@1
          displayName: Publish Build Outputs
          inputs:
            targetPath: $(System.DefaultWorkingDirectory)/app/build/outputs
            artifact: manual-${{ parameters.targetFlavor }}-${{ parameters.buildType }}

      - ${{ if eq(parameters.doInternalTest, true) }}:
        - template: templates/steps/publish-play.yml
          parameters:
            updatePlayListing: ${{ parameters.updatePlayListing }}
            track: internal

      - ${{ if eq(parameters.doPublish, true) }}:
        - template: templates/steps/publish-play.yml
          parameters:
            updatePlayListing: ${{ parameters.updatePlayListing }}
            track: production

      - bash: |
          set -euo pipefail
          rm -f "$(Pipeline.Workspace)/release.jks" "$(Pipeline.Workspace)/service-account.json" firebase_configs.zip
        displayName: Cleanup Secrets
        condition: always()
