name: quality-gate-$(Date:yyyyMMdd)$(Rev:.r)

# PR validation enabled. Push CI remains disabled.
trigger: none
pr:
  branches:
    include:
      - "*"

variables:
  GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx6g -Dorg.gradle.daemon=false
  GRADLE_USER_HOME: $(Agent.ToolsDirectory)/.gradle
  ANDROID_SDK_ROOT: $(Agent.ToolsDirectory)/android-sdk
  ANDROID_HOME: $(Agent.ToolsDirectory)/android-sdk
  ANDROID_API_LEVEL: 36

jobs:
  - job: AnalyzeImpact
    displayName: Analyze Impact
    pool:
      name: MSI
      demands:
        - Agent.Name -equals msi
    steps:
      - checkout: self
        fetchDepth: 0

      - template: templates/steps/setup-android.yml
        parameters:
          androidApiLevel: 36

      - bash: |
          set -euo pipefail

          build_json_array() {
            local -a arr=("$@")
            if [ "${#arr[@]}" -eq 0 ]; then
              echo "[]"
              return
            fi

            local out="["
            local first=true
            for item in "${arr[@]}"; do
              [ -z "$item" ] && continue
              if [ "$first" = false ]; then out+=","; fi
              out+="\"$item\""
              first=false
            done
            out+="]"
            echo "$out"
          }

          if [[ "${BUILD_REASON:-}" == "PullRequest" && -n "${SYSTEM_PULLREQUEST_TARGETBRANCH:-}" ]]; then
            TARGET_BRANCH="${SYSTEM_PULLREQUEST_TARGETBRANCH#refs/heads/}"
            git fetch origin "$TARGET_BRANCH" --depth=1 || true
            CHANGED_FILES="$(git diff --name-only "origin/$TARGET_BRANCH"...HEAD || true)"
          elif git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES="$(git diff --name-only HEAD~1 HEAD || true)"
          else
            CHANGED_FILES="$(git ls-files)"
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          HAS_CODE="false"
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            case "$file" in
              *.kt|*.kts|*.java|*.xml|*.gradle|*.properties|*"/src/"*|buildSrc/*|gradle/*)
                HAS_CODE="true"
                break
                ;;
            esac
          done <<< "$CHANGED_FILES"

          if [ "$HAS_CODE" != "true" ]; then
            echo "##vso[task.setvariable variable=hasCode;isOutput=true]false"
            echo "##vso[task.setvariable variable=flavoursJson;isOutput=true][]"
            exit 0
          fi

          # Run printFlavors once and expose it as an output variable.
          ALL_FLAVOURS_JSON="$(./gradlew -q printFlavors | tr -d '\r')"
          if [ -z "$ALL_FLAVOURS_JSON" ] || [ "$ALL_FLAVOURS_JSON" = "[]" ]; then
            echo "printFlavors returned empty list."
            exit 1
          fi
          echo "##vso[task.setvariable variable=allFlavoursJson;isOutput=true]$ALL_FLAVOURS_JSON"

          if [[ "${BUILD_REASON:-}" == "Manual" ]]; then
            echo "Manual run detected. Forcing quality jobs for all flavours."
            echo "##vso[task.setvariable variable=hasCode;isOutput=true]true"
            echo "##vso[task.setvariable variable=flavoursJson;isOutput=true]$ALL_FLAVOURS_JSON"
            exit 0
          fi

          mapfile -t ALL_FLAVOURS < <(
            echo "$ALL_FLAVOURS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )

          COMMON_CHANGED="false"
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            case "$file" in
              buildSrc/*|core/*|feature/*|gradle/*|app/build.gradle.kts|app/src/main/*|build.gradle.kts|settings.gradle.kts|gradle.properties)
                COMMON_CHANGED="true"
                break
                ;;
            esac
          done <<< "$CHANGED_FILES"

          SELECTED=()
          if [ "$COMMON_CHANGED" = "true" ]; then
            SELECTED=("${ALL_FLAVOURS[@]}")
          else
            for flavour in "${ALL_FLAVOURS[@]}"; do
              if grep -q "^app/src/${flavour}/" <<< "$CHANGED_FILES"; then
                SELECTED+=("$flavour")
              fi
            done
          fi

          SELECTED_JSON="$(build_json_array "${SELECTED[@]}")"

          echo "Detected flavours: $SELECTED_JSON"
          echo "##vso[task.setvariable variable=hasCode;isOutput=true]true"
          echo "##vso[task.setvariable variable=flavoursJson;isOutput=true]$SELECTED_JSON"
        name: setvars
        displayName: Detect Changed Flavours

  - job: StaticAnalysis
    displayName: Detekt & Ktlint
    dependsOn: AnalyzeImpact
    condition: and(succeeded(), eq(dependencies.AnalyzeImpact.outputs['setvars.hasCode'], 'true'))
    variables:
      ALL_FLAVOURS_JSON: $[ dependencies.AnalyzeImpact.outputs['setvars.allFlavoursJson'] ]
    pool:
      name: MSI
      demands:
        - Agent.Name -equals msi
    steps:
      - checkout: self
        fetchDepth: 1

      - template: templates/steps/setup-android.yml
        parameters:
          androidApiLevel: 36

      - bash: |
          set -euo pipefail
          ./gradlew detekt ktlintCheck --stacktrace --no-daemon --max-workers=2
        displayName: Run Static Analysis

      - bash: |
          set -euo pipefail
          mkdir -p "$(Build.ArtifactStagingDirectory)/detekt"
          find . -type d -path "*/build/reports/detekt" -exec cp -R {} "$(Build.ArtifactStagingDirectory)/detekt/" \; || true
        displayName: Collect Detekt Reports
        condition: always()

      - task: PublishPipelineArtifact@1
        displayName: Publish Detekt Reports
        condition: always()
        inputs:
          targetPath: $(Build.ArtifactStagingDirectory)/detekt
          artifact: detekt-report

  - job: AndroidLint
    displayName: Android Lint (Dynamic Flavours)
    dependsOn: AnalyzeImpact
    condition: and(succeeded(), eq(dependencies.AnalyzeImpact.outputs['setvars.hasCode'], 'true'), ne(dependencies.AnalyzeImpact.outputs['setvars.flavoursJson'], '[]'))
    pool:
      name: MSI
      demands:
        - Agent.Name -equals msi
    variables:
      FLAVOURS_JSON: $[ dependencies.AnalyzeImpact.outputs['setvars.flavoursJson'] ]
      ALL_FLAVOURS_JSON: $[ dependencies.AnalyzeImpact.outputs['setvars.allFlavoursJson'] ]
    steps:
      - checkout: self
        fetchDepth: 1

      - template: templates/steps/setup-android.yml
        parameters:
          androidApiLevel: 36

      - bash: |
          set -euo pipefail
          if [ -n "${FIREBASE_CONFIGS_ZIP_BASE64:-}" ] && [[ "${FIREBASE_CONFIGS_ZIP_BASE64}" != '$('* ]]; then
            echo "$FIREBASE_CONFIGS_ZIP_BASE64" | base64 -d > firebase_configs.zip
            unzip -o firebase_configs.zip
            rm -f firebase_configs.zip
          else
            echo "No Firebase override secret, using repository defaults."
          fi

          mapfile -t FLAVOURS < <(
            echo "$(FLAVOURS_JSON)" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )

          TASKS=()
          for flavour in "${FLAVOURS[@]}"; do
            [ -z "$flavour" ] && continue
            FLAVOUR_CAP="$(tr '[:lower:]' '[:upper:]' <<< "${flavour:0:1}")${flavour:1}"
            TASKS+=("lint${FLAVOUR_CAP}Debug")
          done

          if [ "${#TASKS[@]}" -eq 0 ]; then
            echo "No lint task detected."
            exit 0
          fi

          echo "Running lint tasks: ${TASKS[*]}"
          ./gradlew "${TASKS[@]}" --stacktrace --no-daemon --max-workers=2
        displayName: Run Dynamic Lint Tasks
        env:
          FIREBASE_CONFIGS_ZIP_BASE64: $(FIREBASE_CONFIGS_ZIP_BASE64)

      - bash: |
          set -euo pipefail
          mkdir -p "$(Build.ArtifactStagingDirectory)/lint"
          if [ -d "$(System.DefaultWorkingDirectory)/app/build/reports" ]; then
            cp -R "$(System.DefaultWorkingDirectory)/app/build/reports/." "$(Build.ArtifactStagingDirectory)/lint/"
          fi
        displayName: Collect Lint Reports
        condition: always()

      - task: PublishPipelineArtifact@1
        displayName: Publish Lint Reports
        condition: always()
        inputs:
          targetPath: $(Build.ArtifactStagingDirectory)/lint
          artifact: lint-reports
