parameters:
  needSigning: false
  needPlayServiceAccount: false
  keystoreSecureFile: oaslanankaimza.jks
  playServiceAccountSecureFile: play-service-account.json

steps:
  - bash: |
      set -euo pipefail

      is_unresolved() {
        local value="${1:-}"
        [[ "$value" == '$('* || "$value" == '${'* ]]
      }

      require_secret() {
        local name="$1"
        local value="${!name:-}"
        if [ -z "$value" ]; then
          echo "Missing secret: $name"
          exit 1
        fi
        if is_unresolved "$value"; then
          echo "Secret '$name' is unresolved (literal pipeline expression detected)."
          exit 1
        fi
      }

      if [ "${{ parameters.needSigning }}" = "true" ]; then
        require_secret "KEYSTORE_PASSWORD"
        require_secret "KEY_ALIAS"
        require_secret "KEY_PASSWORD"
      fi

      # Note: PLAY_SERVICE_ACCOUNT_JSON must be a file path in this repo's Gradle config.
      # We set it later after DownloadSecureFile.
    displayName: Preflight Secrets
    env:
      KEYSTORE_PASSWORD: $(KEYSTORE_PASSWORD)
      KEY_ALIAS: $(KEY_ALIAS)
      KEY_PASSWORD: $(KEY_PASSWORD)

  - ${{ if eq(parameters.needSigning, true) }}:
    - task: DownloadSecureFile@1
      name: downloadKeystore
      displayName: Download Keystore (Secure File)
      inputs:
        secureFile: ${{ parameters.keystoreSecureFile }}

    - bash: |
        set -euo pipefail
        dest="$(Pipeline.Workspace)/release.jks"
        cp "$(downloadKeystore.secureFilePath)" "$dest"
        echo "Keystore ready at: $dest"
        echo "##vso[task.setvariable variable=KEYSTORE_FILE]$dest"
      displayName: Prepare Keystore Path

  - ${{ if eq(parameters.needPlayServiceAccount, true) }}:
    - task: DownloadSecureFile@1
      name: downloadPlayServiceAccount
      displayName: Download Play Service Account (Secure File)
      inputs:
        secureFile: ${{ parameters.playServiceAccountSecureFile }}

    - bash: |
        set -euo pipefail
        dest="$(Pipeline.Workspace)/service-account.json"
        cp "$(downloadPlayServiceAccount.secureFilePath)" "$dest"
        echo "Service account ready at: $dest"
        echo "##vso[task.setvariable variable=PLAY_SERVICE_ACCOUNT_JSON]$dest"
      displayName: Prepare Play Service Account Path

