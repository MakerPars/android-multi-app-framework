name: Verify Secrets (Redacted)

on:
  workflow_dispatch:

jobs:
  verify:
    name: Verify required secrets without exposing values
    runs-on: ubuntu-latest
    steps:
      - name: Validate secret presence and print lengths only
        shell: bash
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
          PUSH_REGISTRATION_URL: ${{ secrets.PUSH_REGISTRATION_URL }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          set -euo pipefail

          check_secret() {
            local name="$1"
            local min_len="$2"
            local value="${!name:-}"
            local len="${#value}"

            if [ "$len" -lt "$min_len" ]; then
              echo "::error::${name} missing or too short (len=${len}, expected>=${min_len})"
              return 1
            fi

            echo "::notice::${name} OK (len=${len})"
          }

          check_secret DOPPLER_TOKEN 20
          check_secret KEYSTORE_BASE64 1000
          check_secret KEYSTORE_PASSWORD 4
          check_secret KEY_ALIAS 2
          check_secret KEY_PASSWORD 4
          check_secret PLAY_SERVICE_ACCOUNT_JSON_BASE64 500
          check_secret PUSH_REGISTRATION_URL 12
          check_secret SENTRY_AUTH_TOKEN 20

          if [[ "${PUSH_REGISTRATION_URL}" != https://* ]]; then
            echo "::error::PUSH_REGISTRATION_URL must start with https://"
            exit 1
          fi

          echo "::notice::All required secrets are readable. Values were not printed."

      - name: Load Doppler CLI (optional)
        if: ${{ secrets.DOPPLER_TOKEN != '' }}
        uses: dopplerhq/cli-action@v3

      - name: Validate AdMob report secrets from Doppler (length only)
        if: ${{ secrets.DOPPLER_TOKEN != '' }}
        shell: bash
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          set -euo pipefail
          export DOPPLER_PROJECT="android-multi-app-framework"
          export DOPPLER_CONFIG="prod"

          get_doppler_secret() {
            local key="$1"
            doppler secrets get "$key" --plain --project "$DOPPLER_PROJECT" --config "$DOPPLER_CONFIG" 2>/dev/null || true
          }

          check_doppler_secret() {
            local key="$1"
            local min_len="$2"
            local value
            value="$(get_doppler_secret "$key")"
            local len="${#value}"
            if [ "$len" -lt "$min_len" ]; then
              echo "::error::Doppler ${key} missing or too short (len=${len}, expected>=${min_len})"
              return 1
            fi
            echo "::notice::Doppler ${key} OK (len=${len})"
          }

          check_doppler_secret ADMOB_CLIENT_ID 20
          check_doppler_secret ADMOB_CLIENT_SECRET 20
          check_doppler_secret ADMOB_REFRESH_TOKEN 20
          check_doppler_secret ADMOB_PUBLISHER_ID 10
