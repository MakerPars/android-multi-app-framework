name: Release

on:
  workflow_dispatch:
    inputs:
      target_flavors:
        description: 'Target flavors (comma-separated) or "all"'
        required: true
        default: 'all'
        type: string
      update_play_listing:
        description: 'Update Play listing/metadata/screenshots/release-notes'
        required: false
        default: false
        type: boolean
      publish_to_play:
        description: 'Publish to Play Console (production track)'
        required: false
        default: false
        type: boolean

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx6g -Dorg.gradle.daemon=false
  JAVA_VERSION: '21'
  ANDROID_API_LEVEL: 36

jobs:
  build-release:
    name: Build Signed Release AAB
    runs-on: ubuntu-latest
    outputs:
      resolved_flavors_json: ${{ steps.resolve.outputs.resolved_json }}
      resolved_flavors_csv: ${{ steps.resolve.outputs.resolved_csv }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false
          log-accepted-android-sdk-licenses: false

      - name: Install Android SDK packages
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager --sdk_root="$SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "build-tools;36.0.0"

      - name: Accept Android SDK licenses (non-interactive)
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          yes | sdkmanager --licenses --sdk_root="$SDK_ROOT" >/dev/null

      - uses: gradle/actions/setup-gradle@v5

      - name: Resolve Flavors
        id: resolve
        uses: ./.github/actions/resolve-flavors
        with:
          target_flavors: ${{ github.event.inputs.target_flavors }}

      - name: Export resolved flavors env
        run: |
          echo "RESOLVED_FLAVORS_JSON=${{ steps.resolve.outputs.resolved_json }}" >> "$GITHUB_ENV"

      - name: Firebase Config Override (R2 preferred, Base64 fallback)
        uses: ./.github/actions/firebase-config
        with:
          firebase_configs_zip_base64: ${{ secrets.FIREBASE_CONFIGS_ZIP_BASE64 }}
          cf_r2_account_id: ${{ secrets.CF_R2_ACCOUNT_ID }}
          cf_api_token: ${{ secrets.CF_API_TOKEN }}
          cf_r2_bucket: ${{ secrets.CF_R2_BUCKET }}
          cf_r2_firebase_object: ${{ secrets.CF_R2_FIREBASE_OBJECT }}
      - name: Validate Google Sign-In Config
        run: |
          python3 ./scripts/ci/verify_google_signin_config.py --flavors "${{ steps.resolve.outputs.resolved_csv }}"

      - name: Validate Release Signing Secrets
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          set -euo pipefail
          [ -n "$KEYSTORE_BASE64" ] || { echo "::error::Missing secret: KEYSTORE_BASE64"; exit 1; }
          [ -n "$KEYSTORE_PASSWORD" ] || { echo "::error::Missing secret: KEYSTORE_PASSWORD"; exit 1; }
          [ -n "$KEY_ALIAS" ] || { echo "::error::Missing secret: KEY_ALIAS"; exit 1; }
          [ -n "$KEY_PASSWORD" ] || { echo "::error::Missing secret: KEY_PASSWORD"; exit 1; }
          [ -n "$SENTRY_AUTH_TOKEN" ] || { echo "::error::Missing secret: SENTRY_AUTH_TOKEN"; exit 1; }

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > "${{ runner.temp }}/release.jks"
          echo "KEYSTORE_FILE=${{ runner.temp }}/release.jks" >> "$GITHUB_ENV"

      - name: Build Release AAB
        env:
          KEYSTORE_FILE: ${{ runner.temp }}/release.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          set -euo pipefail

          mapfile -t FLAVORS < <(
            echo '${{ steps.resolve.outputs.resolved_json }}' | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )

          TASKS=()
          for flavor in "${FLAVORS[@]}"; do
            [ -z "$flavor" ] && continue
            cap="$(tr '[:lower:]' '[:upper:]' <<< "${flavor:0:1}")${flavor:1}"
            TASKS+=("bundle${cap}Release")
          done

          echo "Running: ${TASKS[*]}"
          ./gradlew "${TASKS[@]}" --stacktrace --no-daemon --max-workers=2

      - name: Upload AAB Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-bundles
          path: app/build/outputs/bundle/
          retention-days: 30

      - name: Cleanup Secrets
        if: always()
        run: rm -f "${{ runner.temp }}/release.jks"

  publish-production:
    name: Publish to Play Console
    needs: build-release
    if: github.event.inputs.publish_to_play == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download AAB Artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-bundles
          path: app/build/outputs/bundle

      - name: Firebase Config Override (R2 preferred, Base64 fallback)
        uses: ./.github/actions/firebase-config
        with:
          firebase_configs_zip_base64: ${{ secrets.FIREBASE_CONFIGS_ZIP_BASE64 }}
          cf_r2_account_id: ${{ secrets.CF_R2_ACCOUNT_ID }}
          cf_api_token: ${{ secrets.CF_API_TOKEN }}
          cf_r2_bucket: ${{ secrets.CF_R2_BUCKET }}
          cf_r2_firebase_object: ${{ secrets.CF_R2_FIREBASE_OBJECT }}

      - name: Validate Google Sign-In Config
        run: |
          python3 ./scripts/ci/verify_google_signin_config.py --flavors "${{ needs.build-release.outputs.resolved_flavors_csv }}"

      - name: Decode Secrets
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          set -euo pipefail
          [ -n "$KEYSTORE_BASE64" ] || { echo "::error::Missing secret: KEYSTORE_BASE64"; exit 1; }
          [ -n "$KEYSTORE_PASSWORD" ] || { echo "::error::Missing secret: KEYSTORE_PASSWORD"; exit 1; }
          [ -n "$KEY_ALIAS" ] || { echo "::error::Missing secret: KEY_ALIAS"; exit 1; }
          [ -n "$KEY_PASSWORD" ] || { echo "::error::Missing secret: KEY_PASSWORD"; exit 1; }
          [ -n "$PLAY_SERVICE_ACCOUNT_JSON_BASE64" ] || { echo "::error::Missing secret: PLAY_SERVICE_ACCOUNT_JSON_BASE64"; exit 1; }
          [ -n "$SENTRY_AUTH_TOKEN" ] || { echo "::error::Missing secret: SENTRY_AUTH_TOKEN"; exit 1; }
          echo "$KEYSTORE_BASE64" | base64 -d > "${{ runner.temp }}/release.jks"
          echo "$PLAY_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > "${{ runner.temp }}/service-account.json"
          echo "KEYSTORE_FILE=${{ runner.temp }}/release.jks" >> "$GITHUB_ENV"
          echo "PLAY_SERVICE_ACCOUNT_JSON=${{ runner.temp }}/service-account.json" >> "$GITHUB_ENV"

      - name: Publish to Play Console
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          PLAY_SERVICE_ACCOUNT_JSON: ${{ runner.temp }}/service-account.json
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          set -euo pipefail
          chmod +x ./gradlew

          RESOLVED_JSON='${{ needs.build-release.outputs.resolved_flavors_json }}'
          mapfile -t FLAVORS < <(
            echo "$RESOLVED_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )

          UPDATE_LISTING="${{ github.event.inputs.update_play_listing }}"
          TASKS=()
          for flavor in "${FLAVORS[@]}"; do
            [ -z "$flavor" ] && continue
            cap="$(tr '[:lower:]' '[:upper:]' <<< "${flavor:0:1}")${flavor:1}"

            if [ "$UPDATE_LISTING" = "true" ]; then
              if [ ! -d "app/src/${flavor}/play" ]; then
                echo "updatePlayListing=true but missing: app/src/${flavor}/play"
                exit 1
              fi
              TASKS+=("publish${cap}ReleaseListing")
            fi

            TASKS+=("publish${cap}ReleaseBundle")
          done

          echo "Publishing: ${TASKS[*]}"
          ./gradlew "${TASKS[@]}" -PPLAY_TRACK=production --stacktrace --no-daemon --max-workers=2

      - name: Cleanup Secrets
        if: always()
        run: rm -f "${{ runner.temp }}/release.jks" "${{ runner.temp }}/service-account.json"

