name: Deploy Admin Notifications Panel

on:
  workflow_dispatch:
    inputs:
      pages_project_name:
        description: "Cloudflare Pages project name"
        required: false
        default: "contentapp-admin-notifications"
      branch_name:
        description: "Pages branch/environment name (e.g. production, preview)"
        required: false
        default: "production"
  push:
    branches:
      - main
    paths:
      - 'admin-notifications/**'
      - '.github/workflows/deploy-admin-notifications.yml'

concurrency:
  group: ${{ format('ci-admin-notifications-pages-{0}', github.ref) }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build & Deploy admin-notifications (Cloudflare Pages)
    runs-on: ubuntu-latest
    env:
      INPUT_PAGES_PROJECT_NAME: ${{ github.event.inputs.pages_project_name }}
      INPUT_BRANCH_NAME: ${{ github.event.inputs.branch_name }}
      CF_PAGES_PROJECT_FALLBACK: ${{ vars.CF_PAGES_ADMIN_NOTIFICATIONS_PROJECT }}
      VITE_FIREBASE_API_KEY: ${{ secrets.FIREBASE_WEB_API_KEY }}
      VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_WEB_AUTH_DOMAIN }}
      VITE_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_WEB_PROJECT_ID }}
      VITE_FIREBASE_APP_ID: ${{ secrets.FIREBASE_WEB_APP_ID }}
      VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_WEB_MESSAGING_SENDER_ID }}
      VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_WEB_STORAGE_BUCKET }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_R2_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: admin-notifications/package-lock.json

      - name: Validate deploy configuration
        shell: bash
        run: |
          set -euo pipefail
          PAGES_PROJECT="${INPUT_PAGES_PROJECT_NAME:-${CF_PAGES_PROJECT_FALLBACK:-}}"
          PAGES_BRANCH="${INPUT_BRANCH_NAME:-production}"

          if [[ -z "${PAGES_PROJECT}" ]]; then
            echo "::error::Cloudflare Pages project name is missing. Set workflow input 'pages_project_name' or repo variable CF_PAGES_ADMIN_NOTIFICATIONS_PROJECT."
            exit 1
          fi

          for key in VITE_FIREBASE_API_KEY VITE_FIREBASE_AUTH_DOMAIN VITE_FIREBASE_PROJECT_ID VITE_FIREBASE_APP_ID CLOUDFLARE_API_TOKEN CLOUDFLARE_ACCOUNT_ID; do
            if [[ -z "${!key:-}" ]]; then
              echo "::error::Missing required secret/env: ${key}"
              exit 1
            fi
          done

          echo "PAGES_PROJECT=${PAGES_PROJECT}" >> "$GITHUB_ENV"
          echo "PAGES_BRANCH=${PAGES_BRANCH}" >> "$GITHUB_ENV"
          echo "::notice::Deploying admin-notifications to Cloudflare Pages project=${PAGES_PROJECT} branch=${PAGES_BRANCH}"

      - name: Install dependencies
        run: npm --prefix admin-notifications ci

      - name: Build admin-notifications
        run: npm --prefix admin-notifications run build

      - name: Deploy to Cloudflare Pages
        shell: bash
        run: |
          set -euo pipefail
          npx wrangler@4 pages deploy admin-notifications/dist \
            --project-name "${PAGES_PROJECT}" \
            --branch "${PAGES_BRANCH}"

