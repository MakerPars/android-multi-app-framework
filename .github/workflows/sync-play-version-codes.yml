name: Sync Play Version Codes

on:
  workflow_dispatch:
    inputs:
      target_flavors:
        description: 'Target flavors (comma-separated) or "all"'
        required: true
        default: 'all'
        type: string

concurrency:
  group: ${{ format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'

jobs:
  sync:
    name: Sync app-versions.properties from Play (artifact only)
    runs-on: ubuntu-latest
    env:
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Resolve Flavors
        id: resolve
        uses: ./.github/actions/resolve-flavors
        with:
          target_flavors: ${{ github.event.inputs.target_flavors }}

      - name: Validate CI apps catalog (warn)
        run: |
          set -euo pipefail
          python3 ./scripts/ci/validate_ci_apps_catalog.py --mode warn --target-flavors "${{ steps.resolve.outputs.resolved_csv }}"

      - name: Load secrets from Doppler (optional)
        if: ${{ env.DOPPLER_TOKEN != '' }}
        uses: dopplerhq/cli-action@v3

      - name: Resolve Play secret (Doppler first, GitHub fallback)
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          set -euo pipefail
          export DOPPLER_PROJECT="android-multi-app-framework"
          export DOPPLER_CONFIG="prod"

          if [ -n "${DOPPLER_TOKEN:-}" ]; then
            val="$(doppler secrets get PLAY_SERVICE_ACCOUNT_JSON_BASE64 --plain --project "$DOPPLER_PROJECT" --config "$DOPPLER_CONFIG" 2>/dev/null || true)"
            if [ -n "$val" ]; then
              echo "::add-mask::$val"
              PLAY_SERVICE_ACCOUNT_JSON_BASE64="$val"
              printf 'PLAY_SERVICE_ACCOUNT_JSON_BASE64=%s\n' "$val" >> "$GITHUB_ENV"
            fi
          fi

          printf 'PLAY_SERVICE_ACCOUNT_JSON_BASE64=%s\n' "${PLAY_SERVICE_ACCOUNT_JSON_BASE64:-${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}}" >> "$GITHUB_ENV"

      - name: Decode Play Service Account
        run: |
          set -euo pipefail
          [ -n "$PLAY_SERVICE_ACCOUNT_JSON_BASE64" ] || { echo "::error::Missing secret: PLAY_SERVICE_ACCOUNT_JSON_BASE64"; exit 1; }
          echo "$PLAY_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > "${{ runner.temp }}/service-account.json"
          echo "PLAY_SERVICE_ACCOUNT_JSON=${{ runner.temp }}/service-account.json" >> "$GITHUB_ENV"

      - name: Sync from Play (all tracks)
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ runner.temp }}/service-account.json
        run: |
          set -euo pipefail
          echo "::notice::Syncing app-versions.properties from Play (tracks=all, flavors=${{ steps.resolve.outputs.resolved_csv }})"
          python3 -m pip install --quiet google-api-python-client google-auth
          python3 ./scripts/ci/fetch_play_version_codes.py \
            --flavors "${{ steps.resolve.outputs.resolved_csv }}" \
            --tracks all \
            --apply-to-app-versions \
            --sync-version-names

      - name: Upload synced app-versions.properties
        uses: actions/upload-artifact@v6
        with:
          name: synced-app-versions
          path: app-versions.properties
          retention-days: 30

      - name: Upload Play versionCode report
        uses: actions/upload-artifact@v6
        with:
          name: play-version-codes-report
          path: |
            TEMP_OUT/play_version_codes.json
            TEMP_OUT/app-versions.properties.suggested
          retention-days: 30

      - name: Cleanup Secrets
        if: always()
        run: rm -f "${{ runner.temp }}/service-account.json"
