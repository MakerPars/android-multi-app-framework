name: Quality Gate

on:
  pull_request:
    branches: ['*']

concurrency:
  group: ${{ format('ci-{0}-{1}', github.workflow, github.event.pull_request.number || github.head_ref || github.ref) }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx6g -Dorg.gradle.daemon=false
  JAVA_VERSION: '21'
  ANDROID_API_LEVEL: 36

jobs:
  analyze-impact:
    name: Analyze Impact
    runs-on: ubuntu-latest
    outputs:
      has_code: ${{ steps.setvars.outputs.has_code }}
      flavours_json: ${{ steps.setvars.outputs.flavours_json }}
      all_flavours_json: ${{ steps.setvars.outputs.all_flavours_json }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false
          log-accepted-android-sdk-licenses: false

      - name: Install Android SDK packages
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager --sdk_root="$SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "build-tools;36.0.0"

      - name: Accept Android SDK licenses (non-interactive)
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          # sdkmanager closes stdin when it has consumed enough answers; `yes` then exits with SIGPIPE.
          # Temporarily disable pipefail so the step result is determined by sdkmanager, not yes.
          set +o pipefail
          yes | sdkmanager --licenses --sdk_root="$SDK_ROOT" >/dev/null
          set -o pipefail

      - uses: gradle/actions/setup-gradle@v5

      - id: setvars
        name: Detect Changed Flavours
        run: |
          set -euo pipefail

          build_json_array() {
            local -a arr=("$@")
            if [ "${#arr[@]}" -eq 0 ]; then echo "[]"; return; fi
            local out="["
            local first=true
            for item in "${arr[@]}"; do
              [ -z "$item" ] && continue
              if [ "$first" = false ]; then out+=","; fi
              out+="\"$item\""
              first=false
            done
            out+="]"
            echo "$out"
          }

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES="$(git diff --name-only origin/${{ github.base_ref }}...HEAD || true)"
          elif git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES="$(git diff --name-only HEAD~1 HEAD || true)"
          else
            CHANGED_FILES="$(git ls-files)"
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          HAS_CODE="false"
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            case "$file" in
              *.kt|*.kts|*.java|*.xml|*.gradle|*.properties|*"/src/"*|buildSrc/*|gradle/*)
                HAS_CODE="true"
                break
                ;;
            esac
          done <<< "$CHANGED_FILES"

          if [ "$HAS_CODE" != "true" ]; then
            echo "has_code=false" >> "$GITHUB_OUTPUT"
            echo "flavours_json=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          chmod +x ./gradlew
          ALL_FLAVOURS_JSON="$(./gradlew -q printFlavors | tr -d '\r')"
          if [ -z "$ALL_FLAVOURS_JSON" ] || [ "$ALL_FLAVOURS_JSON" = "[]" ]; then
            echo "printFlavors returned empty list."
            exit 1
          fi
          echo "all_flavours_json=$ALL_FLAVOURS_JSON" >> "$GITHUB_OUTPUT"

          mapfile -t ALL_FLAVOURS < <(
            echo "$ALL_FLAVOURS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )

          COMMON_CHANGED="false"
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            case "$file" in
              buildSrc/*|core/*|feature/*|gradle/*|app/build.gradle.kts|app/src/main/*|build.gradle.kts|settings.gradle.kts|gradle.properties)
                COMMON_CHANGED="true"
                break
                ;;
            esac
          done <<< "$CHANGED_FILES"

          SELECTED=()
          if [ "$COMMON_CHANGED" = "true" ]; then
            SELECTED=("${ALL_FLAVOURS[@]}")
          else
            for flavour in "${ALL_FLAVOURS[@]}"; do
              if grep -q "^app/src/${flavour}/" <<< "$CHANGED_FILES"; then
                SELECTED+=("$flavour")
              fi
            done
          fi

          SELECTED_JSON="$(build_json_array "${SELECTED[@]}")"
          echo "Detected flavours: $SELECTED_JSON"
          echo "has_code=true" >> "$GITHUB_OUTPUT"
          echo "flavours_json=$SELECTED_JSON" >> "$GITHUB_OUTPUT"

  unit-tests:
    name: Unit Tests
    needs: analyze-impact
    if: needs.analyze-impact.outputs.has_code == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false
          log-accepted-android-sdk-licenses: false

      - name: Install Android SDK packages
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager --sdk_root="$SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "build-tools;36.0.0"

      - name: Accept Android SDK licenses (non-interactive)
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          # sdkmanager closes stdin when it has consumed enough answers; `yes` then exits with SIGPIPE.
          # Temporarily disable pipefail so the step result is determined by sdkmanager, not yes.
          set +o pipefail
          yes | sdkmanager --licenses --sdk_root="$SDK_ROOT" >/dev/null
          set -o pipefail

      - uses: gradle/actions/setup-gradle@v5

      - name: Run Unit Tests
        run: |
          chmod +x ./gradlew
          ./gradlew testDebugUnitTest --stacktrace --no-daemon --max-workers=2

      - name: Publish Test Results
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/test**/TEST-*.xml'

  static-analysis:
    name: Detekt & Ktlint
    needs: analyze-impact
    if: needs.analyze-impact.outputs.has_code == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false
          log-accepted-android-sdk-licenses: false

      - name: Install Android SDK packages
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager --sdk_root="$SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "build-tools;36.0.0"

      - name: Accept Android SDK licenses (non-interactive)
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          # sdkmanager closes stdin when it has consumed enough answers; `yes` then exits with SIGPIPE.
          # Temporarily disable pipefail so the step result is determined by sdkmanager, not yes.
          set +o pipefail
          yes | sdkmanager --licenses --sdk_root="$SDK_ROOT" >/dev/null
          set -o pipefail

      - uses: gradle/actions/setup-gradle@v5

      - name: Run Static Analysis
        run: |
          chmod +x ./gradlew
          ./gradlew detekt ktlintCheck --stacktrace --no-daemon --max-workers=2

      - name: Upload Detekt Reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: detekt-report
          path: '**/build/reports/detekt/**'
          retention-days: 14

  android-lint:
    name: Android Lint
    needs: analyze-impact
    if: >-
      needs.analyze-impact.outputs.has_code == 'true' &&
      needs.analyze-impact.outputs.flavours_json != '[]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false
          log-accepted-android-sdk-licenses: false

      - name: Install Android SDK packages
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager --sdk_root="$SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "build-tools;36.0.0"

      - name: Accept Android SDK licenses (non-interactive)
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          # sdkmanager closes stdin when it has consumed enough answers; `yes` then exits with SIGPIPE.
          # Temporarily disable pipefail so the step result is determined by sdkmanager, not yes.
          set +o pipefail
          yes | sdkmanager --licenses --sdk_root="$SDK_ROOT" >/dev/null
          set -o pipefail

      - uses: gradle/actions/setup-gradle@v5

      - name: Firebase Config Override (R2 preferred, Base64 fallback)
        uses: ./.github/actions/firebase-config
        with:
          firebase_configs_zip_base64: ${{ secrets.FIREBASE_CONFIGS_ZIP_BASE64 }}
          cf_r2_account_id: ${{ secrets.CF_R2_ACCOUNT_ID }}
          cf_api_token: ${{ secrets.CF_API_TOKEN }}
          cf_r2_bucket: ${{ secrets.CF_R2_BUCKET }}
          cf_r2_firebase_object: ${{ secrets.CF_R2_FIREBASE_OBJECT }}
      - name: Run Dynamic Lint Tasks
        env:
          FLAVOURS_JSON: ${{ needs.analyze-impact.outputs.flavours_json }}
        run: |
          set -euo pipefail
          chmod +x ./gradlew

          mapfile -t FLAVOURS < <(
            echo "$FLAVOURS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )

          TASKS=()
          for flavour in "${FLAVOURS[@]}"; do
            [ -z "$flavour" ] && continue
            FLAVOUR_CAP="$(tr '[:lower:]' '[:upper:]' <<< "${flavour:0:1}")${flavour:1}"
            TASKS+=("lint${FLAVOUR_CAP}Debug")
          done

          if [ "${#TASKS[@]}" -eq 0 ]; then
            echo "No lint task detected."
            exit 0
          fi

          echo "Running lint tasks: ${TASKS[*]}"
          ./gradlew "${TASKS[@]}" --stacktrace --no-daemon --max-workers=2

      - name: Upload Lint Reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: lint-reports
          path: 'app/build/reports/**'
          retention-days: 14

