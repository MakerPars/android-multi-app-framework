name: Manual Ops

on:
  workflow_dispatch:
    inputs:
      target_flavor:
        description: 'Target flavor or "all"'
        required: true
        default: 'all'
        type: string
      build_type:
        description: 'Build type'
        required: true
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      do_quality:
        description: 'Run quality checks (detekt/ktlint/lint)'
        required: false
        default: false
        type: boolean
      do_build:
        description: 'Build APK/AAB'
        required: false
        default: true
        type: boolean
      do_internal_test:
        description: 'Publish to Play Internal testing track (Release only)'
        required: false
        default: false
        type: boolean
      do_publish:
        description: 'Publish to Play Production track (Release only)'
        required: false
        default: false
        type: boolean
      update_play_listing:
        description: 'Update Play listing/metadata from repo'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ (github.event.inputs.do_internal_test == 'true' || github.event.inputs.do_publish == 'true') && 'play-publish-global' || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: ${{ github.event.inputs.do_internal_test != 'true' && github.event.inputs.do_publish != 'true' }}

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvmargs=-Xmx1g -Dorg.gradle.workers.max=2 -Dorg.gradle.daemon=false
  JAVA_VERSION: '21'
  ANDROID_API_LEVEL: 36

jobs:
  manual-ops:
    name: Manual Ops
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.do_publish == 'true' && 'production' || '' }}
    env:
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false
          log-accepted-android-sdk-licenses: false

      - name: Install Android SDK packages
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager --sdk_root="$SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "build-tools;36.0.0"

      - name: Accept Android SDK licenses (non-interactive)
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          # sdkmanager closes stdin when it has consumed enough answers; `yes` then exits with SIGPIPE.
          # Temporarily disable pipefail so the step result is determined by sdkmanager, not yes.
          set +o pipefail
          yes | sdkmanager --licenses --sdk_root="$SDK_ROOT" >/dev/null
          set -o pipefail

      - uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Preflight Inputs
        run: |
          if [ "${{ github.event.inputs.do_build }}" = "false" ] && \
             { [ "${{ github.event.inputs.do_internal_test }}" = "true" ] || [ "${{ github.event.inputs.do_publish }}" = "true" ]; }; then
            echo "do_build=false iken publish/internal test çalıştırılamaz. Önce AAB build edilmelidir."
            exit 1
          fi

          if [ "${{ github.event.inputs.do_internal_test }}" = "true" ] || [ "${{ github.event.inputs.do_publish }}" = "true" ]; then
            if [ "${{ github.event.inputs.build_type }}" != "Release" ]; then
              echo "buildType must be Release when publishing."
              exit 1
            fi
          fi

      - name: Resolve Flavors
        id: resolve
        uses: ./.github/actions/resolve-flavors
        with:
          target_flavors: ${{ github.event.inputs.target_flavor }}

      - name: Export resolved flavors env
        run: |
          echo "RESOLVED_FLAVORS_JSON=${{ steps.resolve.outputs.resolved_json }}" >> "$GITHUB_ENV"
          echo "RESOLVED_FLAVORS_CSV=${{ steps.resolve.outputs.resolved_csv }}" >> "$GITHUB_ENV"

      - name: Validate CI apps catalog (warn)
        run: |
          set -euo pipefail
          python3 ./scripts/ci/validate_ci_apps_catalog.py --mode warn --target-flavors "${{ steps.resolve.outputs.resolved_csv }}"

      - name: Validate CI apps catalog (strict for publish)
        if: github.event.inputs.do_internal_test == 'true' || github.event.inputs.do_publish == 'true'
        run: |
          set -euo pipefail
          python3 ./scripts/ci/validate_ci_apps_catalog.py --mode strict --target-flavors "${{ steps.resolve.outputs.resolved_csv }}"

      - name: Firebase Config Override (R2 preferred, Base64 fallback)
        uses: ./.github/actions/firebase-config
        with:
          firebase_configs_zip_base64: ${{ secrets.FIREBASE_CONFIGS_ZIP_BASE64 }}
          cf_r2_account_id: ${{ secrets.CF_R2_ACCOUNT_ID }}
          cf_api_token: ${{ secrets.CF_API_TOKEN }}
          cf_r2_bucket: ${{ secrets.CF_R2_BUCKET }}
          cf_r2_firebase_object: ${{ secrets.CF_R2_FIREBASE_OBJECT }}
      - name: Validate Google Sign-In Config
        run: |
          python3 ./scripts/ci/verify_google_signin_config.py --flavors "${{ steps.resolve.outputs.resolved_csv }}"

      - name: Load secrets from Doppler (optional)
        if: ${{ env.DOPPLER_TOKEN != '' }}
        uses: dopplerhq/cli-action@v3

      - name: Resolve release secrets (Doppler first, GitHub fallback)
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          set -euo pipefail

          export DOPPLER_PROJECT="android-multi-app-framework"
          export DOPPLER_CONFIG="prod"

          load_from_doppler() {
            local key="$1"
            if [ -n "${DOPPLER_TOKEN:-}" ]; then
              local val
              val="$(doppler secrets get "$key" --plain --project "$DOPPLER_PROJECT" --config "$DOPPLER_CONFIG" 2>/dev/null || true)"
              if [ -n "$val" ]; then
                echo "::add-mask::$val"
                printf -v "$key" '%s' "$val"
                export "$key"
                printf '%s=%s\n' "$key" "$val" >> "$GITHUB_ENV"
              fi
            fi
          }

          load_from_doppler KEYSTORE_BASE64
          load_from_doppler KEYSTORE_PASSWORD
          load_from_doppler KEY_ALIAS
          load_from_doppler KEY_PASSWORD
          load_from_doppler PUSH_REGISTRATION_URL
          load_from_doppler SENTRY_AUTH_TOKEN
          load_from_doppler PLAY_SERVICE_ACCOUNT_JSON_BASE64

          printf 'KEYSTORE_BASE64=%s\n' "${KEYSTORE_BASE64:-${{ secrets.KEYSTORE_BASE64 }}}" >> "$GITHUB_ENV"
          printf 'KEYSTORE_PASSWORD=%s\n' "${KEYSTORE_PASSWORD:-${{ secrets.KEYSTORE_PASSWORD }}}" >> "$GITHUB_ENV"
          printf 'KEY_ALIAS=%s\n' "${KEY_ALIAS:-${{ secrets.KEY_ALIAS }}}" >> "$GITHUB_ENV"
          printf 'KEY_PASSWORD=%s\n' "${KEY_PASSWORD:-${{ secrets.KEY_PASSWORD }}}" >> "$GITHUB_ENV"
          printf 'PUSH_REGISTRATION_URL=%s\n' "${PUSH_REGISTRATION_URL:-${{ secrets.PUSH_REGISTRATION_URL }}}" >> "$GITHUB_ENV"
          printf 'SENTRY_AUTH_TOKEN=%s\n' "${SENTRY_AUTH_TOKEN:-${{ secrets.SENTRY_AUTH_TOKEN }}}" >> "$GITHUB_ENV"
          printf 'PLAY_SERVICE_ACCOUNT_JSON_BASE64=%s\n' "${PLAY_SERVICE_ACCOUNT_JSON_BASE64:-${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}}" >> "$GITHUB_ENV"

      - name: Validate Release Signing Secrets
        if: >-
          github.event.inputs.build_type == 'Release' &&
          (github.event.inputs.do_build == 'true' || github.event.inputs.do_internal_test == 'true' || github.event.inputs.do_publish == 'true')
        run: |
          set -euo pipefail
          [ -n "$KEYSTORE_BASE64" ] || { echo "::error::Missing secret: KEYSTORE_BASE64"; exit 1; }
          [ -n "$KEYSTORE_PASSWORD" ] || { echo "::error::Missing secret: KEYSTORE_PASSWORD"; exit 1; }
          [ -n "$KEY_ALIAS" ] || { echo "::error::Missing secret: KEY_ALIAS"; exit 1; }
          [ -n "$KEY_PASSWORD" ] || { echo "::error::Missing secret: KEY_PASSWORD"; exit 1; }
          [ -n "$SENTRY_AUTH_TOKEN" ] || { echo "::error::Missing secret: SENTRY_AUTH_TOKEN"; exit 1; }

      # ── Quality Checks ──
      - name: Run Quality Checks
        if: github.event.inputs.do_quality == 'true'
        run: |
          set -euo pipefail
          ./gradlew detekt ktlintCheck --stacktrace --no-daemon --max-workers=2

          mapfile -t FLAVORS < <(
            echo "$RESOLVED_FLAVORS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )
          TASKS=()
          for flavor in "${FLAVORS[@]}"; do
            [ -z "$flavor" ] && continue
            cap="$(tr '[:lower:]' '[:upper:]' <<< "${flavor:0:1}")${flavor:1}"
            TASKS+=("lint${cap}Debug")
          done
          if [ "${#TASKS[@]}" -gt 0 ]; then
            ./gradlew "${TASKS[@]}" --stacktrace --no-daemon --max-workers=2
          fi

      # ── Secrets Setup ──
      - name: Decode Keystore
        if: >-
          github.event.inputs.build_type == 'Release' &&
          (github.event.inputs.do_build == 'true' || github.event.inputs.do_internal_test == 'true' || github.event.inputs.do_publish == 'true')
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > "${{ runner.temp }}/release.jks"
          echo "KEYSTORE_FILE=${{ runner.temp }}/release.jks" >> "$GITHUB_ENV"

      - name: Decode Play Service Account
        if: github.event.inputs.do_internal_test == 'true' || github.event.inputs.do_publish == 'true'
        run: |
          set -euo pipefail
          [ -n "$PLAY_SERVICE_ACCOUNT_JSON_BASE64" ] || { echo "::error::Missing secret: PLAY_SERVICE_ACCOUNT_JSON_BASE64"; exit 1; }
          echo "$PLAY_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > "${{ runner.temp }}/service-account.json"
          echo "PLAY_SERVICE_ACCOUNT_JSON=${{ runner.temp }}/service-account.json" >> "$GITHUB_ENV"

      - name: Auto-bump Play versionCodes (selected flavors)
        if: >-
          github.event.inputs.build_type == 'Release' &&
          (github.event.inputs.do_internal_test == 'true' || github.event.inputs.do_publish == 'true')
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ runner.temp }}/service-account.json
        run: |
          set -euo pipefail
          [ -f "$PLAY_SERVICE_ACCOUNT_JSON" ] || { echo "::error::PLAY_SERVICE_ACCOUNT_JSON missing"; exit 1; }
          TRACKS=()
          [ "${{ github.event.inputs.do_internal_test }}" = "true" ] && TRACKS+=("internal")
          [ "${{ github.event.inputs.do_publish }}" = "true" ] && TRACKS+=("production")
          TRACKS_CSV="$(IFS=,; echo "${TRACKS[*]}")"
          echo "::notice::Auto-bump starting (tracks=${TRACKS_CSV:-unknown}, flavors=${RESOLVED_FLAVORS_CSV:-unknown})"
          python3 -m pip install --quiet google-api-python-client google-auth
          python3 ./scripts/ci/fetch_play_version_codes.py \
            --flavors "${RESOLVED_FLAVORS_CSV}" \
            --tracks all \
            --suggest-next \
            --apply-to-app-versions \
            --sync-version-names
          echo "::notice::Auto-bump completed (tracks=${TRACKS_CSV:-unknown}, flavors=${RESOLVED_FLAVORS_CSV:-unknown})"
          echo "PLAY_VERSION_AUTO_BUMP_DONE=true" >> "$GITHUB_ENV"

      - name: Guard auto-bump marker before Play publish
        if: >-
          github.event.inputs.build_type == 'Release' &&
          (github.event.inputs.do_internal_test == 'true' || github.event.inputs.do_publish == 'true')
        run: |
          set -euo pipefail
          TRACKS=()
          [ "${{ github.event.inputs.do_internal_test }}" = "true" ] && TRACKS+=("internal")
          [ "${{ github.event.inputs.do_publish }}" = "true" ] && TRACKS+=("production")
          TRACKS_CSV="$(IFS=,; echo "${TRACKS[*]}")"
          if [ "${PLAY_VERSION_AUTO_BUMP_DONE:-}" != "true" ]; then
            echo "::error::Auto-bump marker missing. versionCode bump step did not complete before Play publish."
            echo "::error::Tracks=${TRACKS_CSV:-unknown}, flavors=${RESOLVED_FLAVORS_CSV:-unknown}"
            exit 1
          fi

      # ── Build ──
      - name: Build
        if: github.event.inputs.do_build == 'true'
        run: |
          set -euo pipefail
          BUILD_TYPE="${{ github.event.inputs.build_type }}"

          mapfile -t FLAVORS < <(
            echo "$RESOLVED_FLAVORS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )

          TASKS=()
          for flavor in "${FLAVORS[@]}"; do
            [ -z "$flavor" ] && continue
            cap="$(tr '[:lower:]' '[:upper:]' <<< "${flavor:0:1}")${flavor:1}"
            DO_INTERNAL_TEST="${{ github.event.inputs.do_internal_test }}"
            DO_PUBLISH="${{ github.event.inputs.do_publish }}"

            if [ "$BUILD_TYPE" = "Release" ] && { [ "$DO_INTERNAL_TEST" = "true" ] || [ "$DO_PUBLISH" = "true" ]; }; then
              TASKS+=("bundle${cap}Release")
            else
              TASKS+=("assemble${cap}${BUILD_TYPE}")
            fi
          done

          echo "Running: ${TASKS[*]}"
          ./gradlew "${TASKS[@]}" --stacktrace --no-daemon --max-workers=2

      - name: Notice release artifacts may use repo versionCodes (no Play publish selected)
        if: >-
          github.event.inputs.build_type == 'Release' &&
          github.event.inputs.do_build == 'true' &&
          github.event.inputs.do_internal_test != 'true' &&
          github.event.inputs.do_publish != 'true'
        run: |
          echo "::warning::Release build artifact was created without Play auto-bump (no internal/prod publish selected)."
          echo "::warning::Manual Play upload may fail if versionCode is already used."

      - name: Upload Build Outputs
        if: github.event.inputs.do_build == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: manual-${{ github.event.inputs.target_flavor }}-${{ github.event.inputs.build_type }}
          path: app/build/outputs/
          retention-days: 14

      # ── Play Console Publishing ──
      - name: Publish to Internal Track
        if: github.event.inputs.do_internal_test == 'true'
        run: |
          set -euo pipefail
          mapfile -t FLAVORS < <(
            echo "$RESOLVED_FLAVORS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )
          TASKS=()
          for flavor in "${FLAVORS[@]}"; do
            [ -z "$flavor" ] && continue
            cap="$(tr '[:lower:]' '[:upper:]' <<< "${flavor:0:1}")${flavor:1}"
            if [ "${{ github.event.inputs.update_play_listing }}" = "true" ]; then
              TASKS+=("publish${cap}ReleaseListing")
            fi
            TASKS+=("publish${cap}ReleaseBundle")
          done
          echo "Publishing (internal): ${TASKS[*]}"
          max_attempts=3
          attempt=1
          delay_seconds=20
          while true; do
            log_file="$(mktemp)"
            set +e
            ./gradlew "${TASKS[@]}" -PPLAY_TRACK=internal --stacktrace --no-daemon --max-workers=2 2>&1 | tee "$log_file"
            status=${PIPESTATUS[0]}
            set -e
            if [ "$status" -eq 0 ]; then
              rm -f "$log_file"
              break
            fi
            if ! grep -Eiq "Connection reset|SocketException|Read timed out|timed out|HTTP 429|HTTP 5[0-9]{2}" "$log_file"; then
              echo "Publish failed with non-transient error. Not retrying."
              rm -f "$log_file"
              exit "$status"
            fi
            rm -f "$log_file"
            if [ "$attempt" -ge "$max_attempts" ]; then
              echo "Publish failed after ${max_attempts} attempts."
              exit "$status"
            fi
            echo "Transient publish error detected. Retrying in ${delay_seconds}s (attempt ${attempt}/${max_attempts})..."
            sleep "$delay_seconds"
            attempt=$((attempt + 1))
            delay_seconds=$((delay_seconds * 2))
          done

      - name: Publish to Production Track
        if: github.event.inputs.do_publish == 'true'
        run: |
          set -euo pipefail
          mapfile -t FLAVORS < <(
            echo "$RESOLVED_FLAVORS_JSON" | tr -d '[]"' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d'
          )
          TASKS=()
          for flavor in "${FLAVORS[@]}"; do
            [ -z "$flavor" ] && continue
            cap="$(tr '[:lower:]' '[:upper:]' <<< "${flavor:0:1}")${flavor:1}"
            if [ "${{ github.event.inputs.update_play_listing }}" = "true" ]; then
              TASKS+=("publish${cap}ReleaseListing")
            fi
            TASKS+=("publish${cap}ReleaseBundle")
          done
          echo "Publishing (production): ${TASKS[*]}"
          max_attempts=3
          attempt=1
          delay_seconds=20
          while true; do
            log_file="$(mktemp)"
            set +e
            ./gradlew "${TASKS[@]}" -PPLAY_TRACK=production --stacktrace --no-daemon --max-workers=2 2>&1 | tee "$log_file"
            status=${PIPESTATUS[0]}
            set -e
            if [ "$status" -eq 0 ]; then
              rm -f "$log_file"
              break
            fi
            if ! grep -Eiq "Connection reset|SocketException|Read timed out|timed out|HTTP 429|HTTP 5[0-9]{2}" "$log_file"; then
              echo "Publish failed with non-transient error. Not retrying."
              rm -f "$log_file"
              exit "$status"
            fi
            rm -f "$log_file"
            if [ "$attempt" -ge "$max_attempts" ]; then
              echo "Publish failed after ${max_attempts} attempts."
              exit "$status"
            fi
            echo "Transient publish error detected. Retrying in ${delay_seconds}s (attempt ${attempt}/${max_attempts})..."
            sleep "$delay_seconds"
            attempt=$((attempt + 1))
            delay_seconds=$((delay_seconds * 2))
          done

      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f "${{ runner.temp }}/release.jks" "${{ runner.temp }}/service-account.json"

