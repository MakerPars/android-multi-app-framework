import { execFileSync } from "node:child_process";
import { writeFileSync } from "node:fs";
import { resolve } from "node:path";

const PROJECT = process.env.DOPPLER_PROJECT || "android-multi-app-framework";
const CONFIG = process.env.DOPPLER_CONFIG || "prod";
const OUTPUT = resolve(process.cwd(), ".env");

const requiredKeys = [
  "ADMOB_CLIENT_ID",
  "ADMOB_CLIENT_SECRET",
  "ADMOB_REFRESH_TOKEN",
  "ADMOB_PUBLISHER_ID",
];

const optionalKeys = [
  "AD_HEALTH_MIN_REQUESTS",
  "AD_HEALTH_FILL_RATE_THRESHOLD",
  "AD_HEALTH_SHOW_RATE_THRESHOLD",
];

function readSecret(key, required) {
  try {
    const value = execFileSync(
      "doppler",
      [
        "secrets",
        "get",
        key,
        "--plain",
        "--project",
        PROJECT,
        "--config",
        CONFIG,
      ],
      {
        encoding: "utf8",
        stdio: ["ignore", "pipe", "pipe"],
      },
    ).trim();
    if (!value && required) {
      throw new Error(`Secret "${key}" is empty`);
    }
    return value;
  } catch (error) {
    if (!required) return "";
    throw new Error(`Failed to read required Doppler secret "${key}": ${error.message}`);
  }
}

const lines = [
  "# Auto-generated by scripts/sync-env-from-doppler.mjs",
  `# Doppler project=${PROJECT} config=${CONFIG}`,
];

for (const key of requiredKeys) {
  const value = readSecret(key, true);
  lines.push(`${key}=${value}`);
}

for (const key of optionalKeys) {
  const value = readSecret(key, false);
  if (value) lines.push(`${key}=${value}`);
}

writeFileSync(OUTPUT, `${lines.join("\n")}\n`, "utf8");
console.log(`Wrote ${OUTPUT} with ${requiredKeys.length} required keys.`);
